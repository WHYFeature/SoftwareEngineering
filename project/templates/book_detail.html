{% extends "base.html" %}

{% block title %}{{ book.bookname }} - ä¹¦ç±è¯¦æƒ…{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/books.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">

    <!-- è¿”å›æŒ‰é’® -->
    <a href="{{ url_for('Book.book_list') }}" class="btn btn-outline-secondary mb-4">
        &larr; è¿”å›ä¹¦å•
    </a>

    <!-- ä¸»å†…å®¹ -->
    <div class="row g-4">
        <div class="col-md-10 mx-auto">
            <div class="card shadow-sm">
                <!-- ä½¿ç”¨ row è®©å›¾ç‰‡åŒºåŸŸå’Œå¡ç‰‡å†…å®¹åŒºåŸŸå¹¶åˆ— -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card-body">

                            <!-- æ ‡é¢˜ä¸åº“å­˜ -->
                            <h1 class="card-title display-6">{{ book.bookname }}</h1>
                            <p class="text-muted">åº“å­˜ï¼š{{ book.number }} å†Œ</p>

                            <!-- åŸºæœ¬ä¿¡æ¯ -->
                            <dl class="row">
                                <dt class="col-sm-3">ä½œè€…</dt>
                                <dd class="col-sm-9">{{ book.author }}</dd>
                                <dt class="col-sm-3">å‡ºç‰ˆç¤¾</dt>
                                <dd class="col-sm-9">{{ book.publisher }}</dd>
                            </dl>

                            <!-- ä»·æ ¼åŒºå— -->
                            <div class="bg-light p-3 rounded-3 mb-4">
                                <h3 class="text-danger mb-0">Â¥{{ book.price }}</h3>
                            </div>

                            <!-- åŠ å…¥è´­ç‰©è½¦è¡¨å• -->
                            <form action="{{ url_for('Cart.add_to_cart') }}" method="post" class="needs-validation mb-3" novalidate>
                                <input type="hidden" name="bid" value="{{ book.bid }}">
                                <div class="row g-3 align-items-end">
                                    <!-- æ•°é‡è¾“å…¥æ¡† -->
                                    <div class="col-md-5">
                                        <label for="quantity" class="form-label">æ•°é‡</label>
                                        <input type="number" class="form-control form-control-lg h-100"
                                               id="quantity" name="quantity"
                                               min="1" max="{{ book.number }}" value="1" required>
                                        <div class="invalid-feedback">è¯·è¾“å…¥1è‡³{{ book.number }}ä¹‹é—´çš„æ•°é‡ã€‚</div>
                                    </div>
                            
                                    <!-- æŒ‰é’® -->
                                    <div class="col-md-6 offset-md-1 d-grid">
                                        <label class="form-label invisible">æ“ä½œ</label> <!-- å ä½æ ‡ç­¾ä¿æŒå¯¹é½ -->
                                        <button type="submit" class="btn btn-primary btn-lg"
                                                {% if book.number == 0 %}disabled{% endif %}>
                                            <i class="bi bi-cart-plus"></i> åŠ å…¥è´­ç‰©è½¦
                                        </button>
                                    </div>
                                </div>
                            </form>
                            <!-- æ”¶è—æŒ‰é’®è¡¨å• -->
                            <form action="{{ url_for('Collect.addCollect') }}" method="post" class="favorite-form">
                                <input type="hidden" name="bid" value="{{ book.bid }}">
                                <div class="d-grid d-md-inline">
                                    <button type="submit"
                                            class="btn btn-outline-danger {% if inCollect %}active{% endif %}"
                                            aria-pressed="{{ inCollect|lower }}">
                                        <i class="bi {% if inCollect %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                                        <span class="ms-2">{% if inCollect %}å·²æ”¶è—{% else %}åŠ å…¥æ”¶è—{% endif %}</span>
                                    </button>
                                </div>
                            </form>

                            <!-- æ ·å¼ -->
                            <style>
                                .favorite-form button {
                                    transition: all 0.3s ease;
                                    position: relative;
                                }
                                .favorite-form button:not(.active):hover {
                                    transform: scale(1.05);
                                    box-shadow: 0 0 12px rgba(255, 0, 0, 0.2);
                                }
                                .favorite-form button.active {
                                    background-color: #ff3b30;
                                    color: #fff !important;
                                }
                            </style>

                            <!-- æ”¶è—æŒ‰é’®åŠ è½½æç¤º -->
                            <script>
                                document.querySelectorAll('.favorite-form').forEach(form => {
                                    form.addEventListener('submit', function(e) {
                                        const btn = this.querySelector('button');
                                        btn.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"></div> å¤„ç†ä¸­...`;
                                        btn.disabled = true;
                                    });
                                });
                            </script>

                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <img src="{{ book.img_path }}"
                             alt="å°é¢å›¾ï¼š{{ book.bookname }}"
                             class="img-fluid rounded shadow-sm"
                             style="max-height: 3900px; object-fit: contain;">
                    </div>
                </div>
            </div>

            <!-- å†…å®¹ç®€ä»‹ -->
            <div class="card shadow-sm mt-4">
                <div class="card-body">
                    <h5 class="card-title">å†…å®¹ç®€ä»‹</h5>
                    <p class="text-muted lh-base">{{ book.content }}</p>
                </div>
            </div>

            <!-- è¯„è®ºåŒºå— -->
            <div class="card shadow-sm mt-4">
                <div class="card-body">
                    <h5 class="card-title">è¯„è®º</h5>
                    {% if book.comments %}
                        {% for comment in book.comments %}
                        <div class="border-bottom pb-2 mb-3">
                            <div class="d-flex justify-content-between">
                                <strong>{{ comment.username }}</strong>
                                <small class="text-muted">{{ comment.comment_time }}</small>
                            </div>
                            <p class="mt-1 mb-1">{{ comment.content }}</p>
                             <div class="text-end">
                                <form method="post" action="{{ url_for('Comment.touch_like') }}">
                                    <input type="hidden" name="comment_id" value="{{ comment.comment_id }}">
                                    <button type="submit" class="btn btn-sm btn-outline-primary">
                                        {% if comment.liked %}
                                        ğŸ’– {{ comment.like_count }}
                                          {% else %}
                                        ğŸ¤{{ comment.like_count }}
                                        {% endif %}

                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">æš‚æ— è¯„è®ºã€‚</p>
                    {% endif %}
                </div>
            </div>

            <!-- ç•™è¨€è¡¨å• -->
            <div class="card shadow-sm mt-4 mb-4">
                <div class="card-body">
                    <h5 class="card-title">å‘è¡¨ç•™è¨€</h5>
                    <form method="POST" action="{{ url_for('Comment.add_comment') }}">
                        <input type="hidden" name="bid" value="{{ book.bid }}">
                        <div class="mb-3">
                            <textarea name="content"
                                      id="messageContent"
                                      class="form-control"
                                      rows="3"
                                      placeholder="è¯·è¾“å…¥æ‚¨çš„ç•™è¨€ï¼ˆ5-800ä¸ªå­—ç¬¦ï¼‰"
                                      maxlength="800"
                                      required minlength="5"
                                      oninput="autoResize(this)"></textarea>
                        </div>
                        <script>
                        function autoResize(textarea) {
                            textarea.style.height = 'auto'; // é‡è®¾é«˜åº¦
                            textarea.style.height = textarea.scrollHeight + 'px'; // è®¾ç½®ä¸ºå†…å®¹é«˜åº¦
                        }
                        </script>

                        <style>
                        textarea {
                            overflow-y: hidden; /* ç¦ç”¨ç«–å‘æ»šåŠ¨æ¡ */
                            resize: none;       /* ç¦æ­¢ç”¨æˆ·æ‰‹åŠ¨æ‹–åŠ¨æ”¹å˜å¤§å°ï¼ˆå¯é€‰ï¼‰ */
                        }
                        </style>
                        {% if error %}
                        <div class="alert alert-danger">{{ error }}</div>
                        {% endif %}
                        <div class="text-end mt-3">
                            <button type="submit" class="btn btn-primary">æäº¤ç•™è¨€</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>

</div>
{% endblock %}