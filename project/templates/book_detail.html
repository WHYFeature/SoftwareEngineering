{% extends "base.html" %}

{% block title %}{{ book.bookname }} - ‰π¶Á±çËØ¶ÊÉÖ{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/books.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">

    <!-- ËøîÂõûÊåâÈíÆ -->
    <a href="{{ url_for('Book.book_list') }}" class="btn btn-outline-secondary mb-4">
        &larr; ËøîÂõû‰π¶Âçï
    </a>

    <!-- ‰∏ªÂÜÖÂÆπ -->
    <div class="row g-4">
        <div class="col-md-10 mx-auto">
            <div class="card shadow-sm">
                <div class="card-body">

                    <!-- Ê†áÈ¢ò‰∏éÂ∫ìÂ≠ò -->
                    <h1 class="card-title display-6">{{ book.bookname }}</h1>
                    <p class="text-muted">Â∫ìÂ≠òÔºö{{ book.number }} ÂÜå</p>

                    <!-- Âü∫Êú¨‰ø°ÊÅØ -->
                    <dl class="row">
                        <dt class="col-sm-3">‰ΩúËÄÖ</dt>
                        <dd class="col-sm-9">{{ book.author }}</dd>
                        <dt class="col-sm-3">Âá∫ÁâàÁ§æ</dt>
                        <dd class="col-sm-9">{{ book.publisher }}</dd>
                    </dl>

                    <!-- ‰ª∑Ê†ºÂå∫Âùó -->
                    <div class="bg-light p-3 rounded-3 mb-4">
                        <h3 class="text-danger mb-0">¬•{{ book.price }}</h3>
                    </div>

                    <!-- Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶Ë°®Âçï -->
                    <form action="{{ url_for('Cart.add_to_cart') }}" method="post" class="needs-validation mb-3" novalidate>
                        <input type="hidden" name="bid" value="{{ book.bid }}">
                        <div class="row g-3 align-items-end">
                            <!-- Êï∞ÈáèËæìÂÖ•Ê°Ü -->
                            <div class="col-md-5">
                                <label for="quantity" class="form-label">Êï∞Èáè</label>
                                <input type="number" class="form-control form-control-lg h-100"
                                       id="quantity" name="quantity"
                                       min="1" max="{{ book.number }}" value="1" required>
                                <div class="invalid-feedback">ËØ∑ËæìÂÖ•1Ëá≥{{ book.number }}‰πãÈó¥ÁöÑÊï∞Èáè„ÄÇ</div>
                            </div>
                    
                            <!-- ÊåâÈíÆ -->
                            <div class="col-md-6 offset-md-1 d-grid">
                                <label class="form-label invisible">Êìç‰Ωú</label> <!-- Âç†‰ΩçÊ†áÁ≠æ‰øùÊåÅÂØπÈΩê -->
                                <button type="submit" class="btn btn-primary btn-lg"
                                        {% if book.number == 0 %}disabled{% endif %}>
                                    <i class="bi bi-cart-plus"></i> Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶
                                </button>
                            </div>
                        </div>
                    </form>
                    <!-- Êî∂ËóèÊåâÈíÆË°®Âçï -->
                    <form action="{{ url_for('Collect.addCollect') }}" method="post" class="favorite-form">
                        <input type="hidden" name="bid" value="{{ book.bid }}">
                        <div class="d-grid d-md-inline">
                            <button type="submit"
                                    class="btn btn-outline-danger {% if inCollect %}active{% endif %}"
                                    aria-pressed="{{ inCollect|lower }}">
                                <i class="bi {% if inCollect %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                                <span class="ms-2">{% if inCollect %}Â∑≤Êî∂Ëóè{% else %}Âä†ÂÖ•Êî∂Ëóè{% endif %}</span>
                            </button>
                        </div>
                    </form>

                    <!-- Ê†∑Âºè -->
                    <style>
                        .favorite-form button {
                            transition: all 0.3s ease;
                            position: relative;
                        }
                        .favorite-form button:not(.active):hover {
                            transform: scale(1.05);
                            box-shadow: 0 0 12px rgba(255, 0, 0, 0.2);
                        }
                        .favorite-form button.active {
                            background-color: #ff3b30;
                            color: #fff !important;
                        }
                    </style>

                    <!-- Êî∂ËóèÊåâÈíÆÂä†ËΩΩÊèêÁ§∫ -->
                    <script>
                        document.querySelectorAll('.favorite-form').forEach(form => {
                            form.addEventListener('submit', function(e) {
                                const btn = this.querySelector('button');
                                btn.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"></div> Â§ÑÁêÜ‰∏≠...`;
                                btn.disabled = true;
                            });
                        });
                    </script>

                </div>
            </div>

            <!-- ÂÜÖÂÆπÁÆÄ‰ªã -->
            <div class="card shadow-sm mt-4">
                <div class="card-body">
                    <h5 class="card-title">ÂÜÖÂÆπÁÆÄ‰ªã</h5>
                    <p class="text-muted lh-base">{{ book.content }}</p>
                </div>
            </div>

            <!-- ËØÑËÆ∫Âå∫Âùó -->
            <div class="card shadow-sm mt-4">
                <div class="card-body">
                    <h5 class="card-title">ËØÑËÆ∫</h5>
                    {% if book.comments %}
                        {% for comment in book.comments %}
                        <div class="border-bottom pb-2 mb-3">
                            <div class="d-flex justify-content-between">
                                <strong>{{ comment.username }}</strong>
                                <small class="text-muted">{{ comment.comment_time }}</small>
                            </div>
                            <p class="mt-1 mb-1">{{ comment.content }}</p>
                             <div class="text-end">
                                <form method="post" action="{{ url_for('Comment.touch_like') }}">
                                    <input type="hidden" name="comment_id" value="{{ comment.comment_id }}">
                                    <button type="submit" class="btn btn-sm btn-outline-primary">
                                        {% if comment.liked %}
                                        üíñ {{ comment.like_count }}
                                          {% else %}
                                        ü§ç{{ comment.like_count }}
                                        {% endif %}

                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">ÊöÇÊó†ËØÑËÆ∫„ÄÇ</p>
                    {% endif %}
                </div>
            </div>

            <!-- ÁïôË®ÄË°®Âçï -->
            <div class="card shadow-sm mt-4 mb-4">
                <div class="card-body">
                    <h5 class="card-title">ÂèëË°®ÁïôË®Ä</h5>
                    <form method="POST" action="{{ url_for('Comment.add_comment') }}">
                        <input type="hidden" name="bid" value="{{ book.bid }}">
                        <div class="mb-3">
                            <textarea name="content"
                                      class="form-control"
                                      rows="3"
                                      placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÁïôË®ÄÔºàËá≥Â∞ë5‰∏™Â≠óÁ¨¶Ôºâ"
                                      required minlength="5"></textarea>
                        </div>
                        {% if error %}
                        <div class="alert alert-danger">{{ error }}</div>
                        {% endif %}
                        <div class="text-end mt-3">
                            <button type="submit" class="btn btn-primary">Êèê‰∫§ÁïôË®Ä</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>

</div>
{% endblock %}
